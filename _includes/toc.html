{%- comment -%}
Usage:
{% include toc.html h_min=2 h_max=3 class="post-toc" title="목차" %}
{%- endcomment -%}

<nav id="post-toc" class="{{ include.class | default: 'post-toc' }}" aria-label="{{ include.title | default: '목차' }}"
    data-hmin="{{ include.h_min | default: 2 }}" data-hmax="{{ include.h_max | default: 3 }}" hidden>
    <strong class="post-toc__title">{{ include.title | default: '목차' }}</strong>
    <ol class="post-toc__list"></ol>
</nav>

<script>
    (function () {
        function ready(fn) {
            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
            else fn();
        }

        ready(function () {
            var toc = document.getElementById('post-toc');
            if (!toc) return;

            var min = parseInt(toc.dataset.hmin || '2', 10);
            var max = parseInt(toc.dataset.hmax || '3', 10);
            if (isNaN(min)) min = 2;
            if (isNaN(max)) max = 3;

            // 컨테이너를 본문 바로 앞 위치로 보장
            var pc = document.querySelector('.post .post-content, .post-content');
            if (!pc) return;
            if (toc.parentNode !== pc.parentNode || toc.nextElementSibling !== pc) {
                pc.parentNode.insertBefore(toc, pc);
            }

            // 본문 내 H2~Hn 수집
            var sels = [];
            for (var i = min; i <= max; i++) sels.push('.post .post-content h' + i);
            var headings = document.querySelectorAll(sels.join(','));
            if (!headings || headings.length < 2) { toc.remove(); return; }

            var list = toc.querySelector('.post-toc__list');
            var used = {};

            function slugify(text) {
                var id = (text || '').toString().trim().toLowerCase()
                    .replace(/[^\uAC00-\uD7A3\w\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-')
                    .replace(/^-+|-+$/g, '');
                if (!id) id = 'section';
                var base = id, n = 2;
                while (used[id] || document.getElementById(id)) { id = base + '-' + (n++); }
                used[id] = 1;
                return id;
            }

            headings.forEach(function (h) {
                if (!h.id) h.id = slugify(h.textContent);
                var level = parseInt(h.tagName.slice(1), 10);
                var li = document.createElement('li');
                li.className = 'post-toc__item post-toc__item--h' + level;

                var a = document.createElement('a');
                a.className = 'post-toc__link';
                a.href = '#' + h.id;
                a.textContent = h.textContent.trim();

                li.appendChild(a);
                list.appendChild(li);
            });

            toc.hidden = false;
        });
    })();
</script>

<style>
    .post-toc {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 12px 14px;
        margin: 16px 0;
        background: #fff
    }

    .post-toc__title {
        display: block;
        margin-bottom: 8px;
        font-weight: 800;
        font-size: 1rem;
        color: #111827
    }

    .post-toc__list {
        margin: 0;
        padding-left: 18px
    }

    .post-toc__item {
        margin: 4px 0
    }

    .post-toc__item--h3 {
        margin-left: 10px
    }
</style>